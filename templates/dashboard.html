{% extends "base.html" %}

{% block title %}لوحة التحكم - نظام VNC Desktop المتطور{% endblock %}

{% block content %}
<div class="row">
    <!-- Page Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-chart-line me-2"></i>لوحة التحكم المتقدمة</h2>
            <div>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt me-1"></i>
                    تحديث
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Server Status Overview -->
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card status-card h-100">
            <div class="card-body text-center">
                <i class="fas fa-server fa-3x text-primary mb-3"></i>
                <h5>حالة الخادم</h5>
                <h3 class="text-primary" id="server-status-text">جاري الفحص...</h3>
                <div class="mt-3">
                    <small class="text-muted">آخر فحص: <span id="last-check">-</span></small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Active Sessions -->
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card status-card h-100">
            <div class="card-body text-center">
                <i class="fas fa-users fa-3x text-success mb-3"></i>
                <h5>الجلسات النشطة</h5>
                <h3 class="text-success" id="active-sessions-count">0</h3>
                <div class="mt-3">
                    <small class="text-muted">إجمالي الاتصالات اليوم: <span id="total-connections">-</span></small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Load -->
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card status-card h-100">
            <div class="card-body text-center">
                <i class="fas fa-tachometer-alt fa-3x text-warning mb-3"></i>
                <h5>حمولة النظام</h5>
                <h3 class="text-warning" id="system-load">-</h3>
                <div class="mt-3">
                    <small class="text-muted">متوسط آخر دقيقة</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Performance Metrics -->
    <div class="col-lg-8 mb-4">
        <div class="card status-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-area me-2"></i>
                    مقاييس الأداء
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            <h6>المعالج</h6>
                            <div class="progress mb-2" style="height: 10px;">
                                <div class="progress-bar bg-primary" role="progressbar" id="cpu-progress" style="width: 0%"></div>
                            </div>
                            <span class="text-muted" id="cpu-percentage">0%</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            <h6>الذاكرة</h6>
                            <div class="progress mb-2" style="height: 10px;">
                                <div class="progress-bar bg-success" role="progressbar" id="memory-progress" style="width: 0%"></div>
                            </div>
                            <span class="text-muted" id="memory-percentage">0%</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            <h6>التخزين</h6>
                            <div class="progress mb-2" style="height: 10px;">
                                <div class="progress-bar bg-warning" role="progressbar" id="disk-progress" style="width: 0%"></div>
                            </div>
                            <span class="text-muted" id="disk-percentage">0%</span>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <small class="text-muted d-block">
                            <i class="fas fa-memory me-1"></i>
                            الذاكرة المستخدمة: <span id="memory-used">-</span> / <span id="memory-total">-</span> GB
                        </small>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted d-block">
                            <i class="fas fa-hdd me-1"></i>
                            التخزين المستخدم: <span id="disk-used">-</span> / <span id="disk-total">-</span> GB
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="col-lg-4 mb-4">
        <div class="card status-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    إجراءات سريعة
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="toggleVNC()">
                        <i class="fas fa-power-off me-2"></i>
                        <span id="vnc-toggle-text">بدء VNC</span>
                    </button>
                    
                    <button class="btn btn-success" onclick="openTerminal()">
                        <i class="fas fa-terminal me-2"></i>
                        فتح المحطة الطرفية
                    </button>
                    
                    <button class="btn btn-warning" onclick="restartServices()">
                        <i class="fas fa-redo me-2"></i>
                        إعادة تشغيل الخدمات
                    </button>
                    
                    <button class="btn btn-info" onclick="downloadLogs()">
                        <i class="fas fa-download me-2"></i>
                        تحميل السجلات
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Sessions -->
    <div class="col-lg-6 mb-4">
        <div class="card status-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>
                    الجلسات الأخيرة
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>اسم الجلسة</th>
                                <th>المنفذ</th>
                                <th>الحالة</th>
                                <th>وقت الإنشاء</th>
                            </tr>
                        </thead>
                        <tbody id="recent-sessions">
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    جاري تحميل البيانات...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Activity Log -->
    <div class="col-lg-6 mb-4">
        <div class="card status-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>
                    سجل النشاطات
                </h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <div id="activity-log">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        جاري تحميل السجلات...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Network Information -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card status-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-network-wired me-2"></i>
                    معلومات الشبكة
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <h6>البيانات المرسلة</h6>
                        <span class="text-primary" id="bytes-sent">-</span>
                    </div>
                    <div class="col-md-3 text-center">
                        <h6>البيانات المستلمة</h6>
                        <span class="text-success" id="bytes-received">-</span>
                    </div>
                    <div class="col-md-3 text-center">
                        <h6>الحزم المرسلة</h6>
                        <span class="text-warning" id="packets-sent">-</span>
                    </div>
                    <div class="col-md-3 text-center">
                        <h6>الحزم المستلمة</h6>
                        <span class="text-info" id="packets-received">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let dashboardData = {};

function refreshDashboard() {
    // Get VNC status
    makeRequest('/api/vnc/status')
        .done(function(data) {
            updateVNCStatus(data);
        });
    
    // Get system info
    makeRequest('/api/system/info')
        .done(function(data) {
            updateSystemInfo(data);
        });
    
    // Update timestamp
    $('#last-check').text(new Date().toLocaleString('ar-SA'));
}

function updateVNCStatus(status) {
    dashboardData.vnc = status;
    
    // Update server status
    if (status.is_running) {
        $('#server-status-text').text('يعمل').removeClass('text-danger').addClass('text-success');
        $('#vnc-toggle-text').text('إيقاف VNC');
    } else {
        $('#server-status-text').text('متوقف').removeClass('text-success').addClass('text-danger');
        $('#vnc-toggle-text').text('بدء VNC');
    }
    
    // Update active sessions
    $('#active-sessions-count').text(status.total_sessions || 0);
}

function updateSystemInfo(info) {
    dashboardData.system = info;
    
    if (info.performance) {
        const perf = info.performance;
        
        // Update progress bars
        $('#cpu-progress').css('width', perf.cpu_percent + '%');
        $('#cpu-percentage').text(perf.cpu_percent + '%');
        
        $('#memory-progress').css('width', perf.memory_percent + '%');
        $('#memory-percentage').text(perf.memory_percent + '%');
        
        $('#disk-progress').css('width', perf.disk_percent + '%');
        $('#disk-percentage').text(perf.disk_percent + '%');
        
        // Update detailed info
        $('#memory-used').text(perf.memory_used_gb);
        $('#memory-total').text(perf.memory_total_gb);
        $('#disk-used').text(perf.disk_used_gb);
        $('#disk-total').text(perf.disk_total_gb);
        
        // Update system load (using CPU as approximation)
        $('#system-load').text(perf.cpu_percent + '%');
    }
    
    if (info.network) {
        const network = info.network;
        $('#bytes-sent').text(formatBytes(network.bytes_sent));
        $('#bytes-received').text(formatBytes(network.bytes_recv));
        $('#packets-sent').text(network.packets_sent);
        $('#packets-received').text(network.packets_recv);
    }
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function toggleVNC() {
    const isRunning = dashboardData.vnc && dashboardData.vnc.is_running;
    
    if (isRunning) {
        makeRequest('/api/vnc/stop', 'POST')
            .done(function(data) {
                showNotification('تم إيقاف خادم VNC', 'success');
                refreshDashboard();
            })
            .fail(function() {
                showNotification('فشل في إيقاف خادم VNC', 'danger');
            });
    } else {
        makeRequest('/api/vnc/start', 'POST')
            .done(function(data) {
                showNotification('تم بدء خادم VNC', 'success');
                refreshDashboard();
            })
            .fail(function() {
                showNotification('فشل في بدء خادم VNC', 'danger');
            });
    }
}

function openTerminal() {
    showNotification('فتح المحطة الطرفية غير متوفر حالياً', 'info');
}

function restartServices() {
    showNotification('جاري إعادة تشغيل الخدمات...', 'info');
    setTimeout(function() {
        refreshDashboard();
        showNotification('تم إعادة تشغيل الخدمات', 'success');
    }, 2000);
}

function downloadLogs() {
    window.open('/logs', '_blank');
}

// Update dashboard every 30 seconds
setInterval(refreshDashboard, 30000);

// Initialize dashboard
$(document).ready(function() {
    refreshDashboard();
});

// Socket event handlers
socket.on('vnc_status_update', updateVNCStatus);
socket.on('system_info_update', updateSystemInfo);
</script>
{% endblock %}