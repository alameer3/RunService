{% extends "base.html" %}

{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© - Ø®Ø§Ø¯Ù… VNC{% endblock %}

{% block content %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }
    
    .dashboard-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        border-left: 5px solid #007bff;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .dashboard-card h3 {
        color: #495057;
        margin-bottom: 15px;
        font-size: 1.2em;
    }
    
    .stat-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #007bff;
        margin-bottom: 10px;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9em;
    }
    
    .logs-container {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .log-entry {
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 6px;
        background: white;
        border-left: 4px solid #28a745;
        font-size: 0.9em;
    }
    
    .log-entry.error {
        border-left-color: #dc3545;
    }
    
    .log-time {
        color: #6c757d;
        font-size: 0.8em;
    }
    
    .session-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
    }
    
    .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 25px;
    }
    
    .admin-controls {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
    }
    
    .performance-metrics {
        background: #e8f5e8;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
    }
</style>

<div class="session-info">
    <h2>ğŸ“Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
    {% if session %}
        <p><strong>Ø§Ø³Ù… Ø§Ù„Ø¬Ù„Ø³Ø©:</strong> {{ session.session_name }}</p>
        <p><strong>ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong> {{ session.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        <p><strong>Ø¢Ø®Ø± ÙˆØµÙˆÙ„:</strong> {{ session.last_accessed.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> {{ 'Ù†Ø´Ø·' if session.is_active else 'ØºÙŠØ± Ù†Ø´Ø·' }}</p>
        <p><strong>Ø§Ù„Ù…Ù†ÙØ°:</strong> {{ session.vnc_port }}</p>
        <p><strong>Ø¯Ù‚Ø© Ø§Ù„Ø´Ø§Ø´Ø©:</strong> {{ session.screen_resolution }}</p>
    {% else %}
        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
    {% endif %}
</div>

<div class="dashboard-grid">
    <div class="dashboard-card">
        <h3>ğŸ”„ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù…</h3>
        <div class="stat-value">{{ 'ON' if server_status else 'OFF' }}</div>
        <div class="stat-label">{{ 'ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ' if server_status else 'Ù…ØªÙˆÙ‚Ù Ø­Ø§Ù„ÙŠØ§Ù‹' }}</div>
    </div>
    
    <div class="dashboard-card">
        <h3>ğŸ“ˆ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª</h3>
        <div class="stat-value">{{ recent_logs|length }}</div>
        <div class="stat-label">ÙÙŠ Ø¢Ø®Ø± 20 Ø¹Ù…Ù„ÙŠØ©</div>
    </div>
    
    <div class="dashboard-card">
        <h3>â° ÙˆÙ‚Øª Ø§Ù„ØªØ´ØºÙŠÙ„</h3>
        <div class="stat-value">{{ session.created_at.strftime('%H:%M') if session else '--:--' }}</div>
        <div class="stat-label">Ù…Ù†Ø° Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„</div>
    </div>
    
    <div class="dashboard-card">
        <h3>ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
        <div class="stat-value" style="font-size: 1.5em;">vnc123456</div>
        <div class="stat-label">ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± VNC</div>
    </div>
</div>

<div class="admin-controls">
    <h3>âš™ï¸ Ø£Ø¯ÙˆØ§Øª Ø¥Ø¯Ø§Ø±ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
    <div class="controls-grid">
        <button class="btn btn-primary" onclick="restartVncServer()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ VNC</button>
        <button class="btn btn-warning" onclick="clearLogs()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
        <button class="btn btn-success" onclick="exportLogs()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
        <button class="btn btn-primary" onclick="systemStatus()">ğŸ–¥ï¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        <button class="btn btn-warning" onclick="changePassword()">ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
        <button class="btn btn-primary" onclick="changeResolution()">ğŸ“º ØªØºÙŠÙŠØ± Ø§Ù„Ø¯Ù‚Ø©</button>
    </div>
</div>

<div class="performance-metrics">
    <h3>ğŸ“Š Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ø£Ø¯Ø§Ø¡</h3>
    <div class="dashboard-grid">
        <div>
            <strong>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬:</strong>
            <div class="progress-bar" style="background: #e9ecef; height: 10px; border-radius: 5px; margin-top: 5px;">
                <div style="background: #28a745; height: 100%; width: 25%; border-radius: 5px;"></div>
            </div>
            <small>25% Ù…ØªÙˆØ³Ø·</small>
        </div>
        <div>
            <strong>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø©:</strong>
            <div class="progress-bar" style="background: #e9ecef; height: 10px; border-radius: 5px; margin-top: 5px;">
                <div style="background: #ffc107; height: 100%; width: 60%; border-radius: 5px;"></div>
            </div>
            <small>60% Ù…Ù† 1GB</small>
        </div>
    </div>
</div>

<div class="logs-container">
    <h3>ğŸ“‹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h3>
    {% if recent_logs %}
        {% for log in recent_logs %}
        <div class="log-entry {{ 'error' if not log.success else '' }}">
            <div class="log-time">{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</div>
            <div>
                <strong>{{ log.action }}:</strong> {{ log.message }}
                {% if log.client_ip %}
                    <small>(Ù…Ù† {{ log.client_ip }})</small>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ØªØ§Ø­Ø©</p>
    {% endif %}
</div>

<div style="text-align: center; margin-top: 30px;">
    <a href="/" class="btn btn-primary">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a href="/external-access" class="btn btn-success">ğŸŒ Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ</a>
    <a href="/download" class="btn btn-warning">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø¨Ø±Ø§Ù…Ø¬ VNC</a>
</div>

<script>
function restartVncServer() {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù… VNCØŸ Ù‚Ø¯ ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ù„Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
        fetch('/stop', {method: 'POST'})
        .then(() => {
            setTimeout(() => {
                fetch('/start', {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    setTimeout(() => window.location.reload(), 2000);
                });
            }, 2000);
        });
    }
}

function clearLogs() {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
        fetch('/admin/clear-logs', {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            window.location.reload();
        });
    }
}

function exportLogs() {
    window.open('/logs', '_blank');
}

function systemStatus() {
    fetch('/admin/system-status')
    .then(response => response.text())
    .then(data => {
        const statusWindow = window.open('', '_blank', 'width=800,height=600');
        statusWindow.document.write('<html><head><title>Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</title></head><body>');
        statusWindow.document.write('<h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>');
        statusWindow.document.write('<pre style="background:#f8f9fa;padding:15px;border-radius:5px;font-family:monospace;">' + data + '</pre>');
        statusWindow.document.write('</body></html>');
    });
}

function changePassword() {
    const newPassword = prompt('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (6-20 Ø­Ø±Ù):');
    if (newPassword && newPassword.length >= 6 && newPassword.length <= 20) {
        fetch('/admin/change-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({password: newPassword})
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        });
    } else if (newPassword) {
        alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 6-20 Ø­Ø±Ù');
    }
}

function changeResolution() {
    const resolutions = ['1024x768', '1280x720', '1280x1024', '1920x1080'];
    const current = '{{ session.screen_resolution if session else "1024x768" }}';
    let choice = '';
    
    for (let i = 0; i < resolutions.length; i++) {
        choice += `${i + 1}. ${resolutions[i]}${resolutions[i] === current ? ' (Ø­Ø§Ù„ÙŠ)' : ''}\n`;
    }
    
    const selection = prompt(`Ø§Ø®ØªØ± Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:\n${choice}\nØ£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… (1-4):`);
    const index = parseInt(selection) - 1;
    
    if (index >= 0 && index < resolutions.length) {
        fetch('/admin/change-resolution', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({resolution: resolutions[index]})
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        });
    }
}

// Auto-refresh every 30 seconds
setInterval(() => {
    window.location.reload();
}, 30000);
</script>
{% endblock %}