{% extends "base.html" %}

{% block title %}لوحة التحكم الإدارية - خادم VNC{% endblock %}

{% block content %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }
    
    .dashboard-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        border-left: 5px solid #007bff;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .dashboard-card h3 {
        color: #495057;
        margin-bottom: 15px;
        font-size: 1.2em;
    }
    
    .stat-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #007bff;
        margin-bottom: 10px;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9em;
    }
    
    .logs-container {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .log-entry {
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 6px;
        background: white;
        border-left: 4px solid #28a745;
        font-size: 0.9em;
    }
    
    .log-entry.error {
        border-left-color: #dc3545;
    }
    
    .log-time {
        color: #6c757d;
        font-size: 0.8em;
    }
    
    .session-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
    }
    
    .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 25px;
    }
    
    .admin-controls {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
    }
    
    .performance-metrics {
        background: #e8f5e8;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
    }
</style>

<div class="session-info">
    <h2>📊 معلومات الجلسة الحالية</h2>
    {% if session %}
        <p><strong>اسم الجلسة:</strong> {{ session.session_name }}</p>
        <p><strong>وقت الإنشاء:</strong> {{ session.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        <p><strong>آخر وصول:</strong> {{ session.last_accessed.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        <p><strong>الحالة:</strong> {{ 'نشط' if session.is_active else 'غير نشط' }}</p>
        <p><strong>المنفذ:</strong> {{ session.vnc_port }}</p>
        <p><strong>دقة الشاشة:</strong> {{ session.screen_resolution }}</p>
    {% else %}
        <p>لا توجد جلسة نشطة حالياً</p>
    {% endif %}
</div>

<div class="dashboard-grid">
    <div class="dashboard-card">
        <h3>🔄 حالة الخادم</h3>
        <div class="stat-value">{{ 'ON' if server_status else 'OFF' }}</div>
        <div class="stat-label">{{ 'يعمل بشكل طبيعي' if server_status else 'متوقف حالياً' }}</div>
    </div>
    
    <div class="dashboard-card">
        <h3>📈 إجمالي الاتصالات</h3>
        <div class="stat-value">{{ recent_logs|length }}</div>
        <div class="stat-label">في آخر 20 عملية</div>
    </div>
    
    <div class="dashboard-card">
        <h3>⏰ وقت التشغيل</h3>
        <div class="stat-value">{{ session.created_at.strftime('%H:%M') if session else '--:--' }}</div>
        <div class="stat-label">منذ بدء التشغيل</div>
    </div>
    
    <div class="dashboard-card">
        <h3>🔑 كلمة المرور</h3>
        <div class="stat-value" style="font-size: 1.5em;">vnc123456</div>
        <div class="stat-label">كلمة مرور VNC</div>
    </div>
</div>

<div class="admin-controls">
    <h3>⚙️ أدوات إدارية متقدمة</h3>
    <div class="controls-grid">
        <button class="btn btn-primary" onclick="restartVncServer()">🔄 إعادة تشغيل VNC</button>
        <button class="btn btn-warning" onclick="clearLogs()">🗑️ مسح السجلات</button>
        <button class="btn btn-success" onclick="exportLogs()">📥 تصدير السجلات</button>
        <button class="btn btn-primary" onclick="systemStatus()">🖥️ حالة النظام</button>
        <button class="btn btn-warning" onclick="changePassword()">🔑 تغيير كلمة المرور</button>
        <button class="btn btn-primary" onclick="changeResolution()">📺 تغيير الدقة</button>
    </div>
</div>

<div class="performance-metrics">
    <h3>📊 مقاييس الأداء</h3>
    <div class="dashboard-grid">
        <div>
            <strong>استخدام المعالج:</strong>
            <div class="progress-bar" style="background: #e9ecef; height: 10px; border-radius: 5px; margin-top: 5px;">
                <div style="background: #28a745; height: 100%; width: 25%; border-radius: 5px;"></div>
            </div>
            <small>25% متوسط</small>
        </div>
        <div>
            <strong>استخدام الذاكرة:</strong>
            <div class="progress-bar" style="background: #e9ecef; height: 10px; border-radius: 5px; margin-top: 5px;">
                <div style="background: #ffc107; height: 100%; width: 60%; border-radius: 5px;"></div>
            </div>
            <small>60% من 1GB</small>
        </div>
    </div>
</div>

<div class="logs-container">
    <h3>📋 سجلات النشاط الأخيرة</h3>
    {% if recent_logs %}
        {% for log in recent_logs %}
        <div class="log-entry {{ 'error' if not log.success else '' }}">
            <div class="log-time">{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</div>
            <div>
                <strong>{{ log.action }}:</strong> {{ log.message }}
                {% if log.client_ip %}
                    <small>(من {{ log.client_ip }})</small>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <p>لا توجد سجلات متاحة</p>
    {% endif %}
</div>

<div style="text-align: center; margin-top: 30px;">
    <a href="/" class="btn btn-primary">🏠 العودة للصفحة الرئيسية</a>
    <a href="/external-access" class="btn btn-success">🌐 الوصول الخارجي</a>
    <a href="/download" class="btn btn-warning">📥 تحميل برامج VNC</a>
</div>

<script>
function restartVncServer() {
    if (confirm('هل تريد إعادة تشغيل خادم VNC؟ قد يؤدي هذا لقطع الاتصالات الحالية.')) {
        fetch('/stop', {method: 'POST'})
        .then(() => {
            setTimeout(() => {
                fetch('/start', {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    setTimeout(() => window.location.reload(), 2000);
                });
            }, 2000);
        });
    }
}

function clearLogs() {
    if (confirm('هل تريد مسح جميع السجلات؟ لا يمكن التراجع عن هذا الإجراء.')) {
        fetch('/admin/clear-logs', {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            window.location.reload();
        });
    }
}

function exportLogs() {
    window.open('/logs', '_blank');
}

function systemStatus() {
    fetch('/admin/system-status')
    .then(response => response.text())
    .then(data => {
        const statusWindow = window.open('', '_blank', 'width=800,height=600');
        statusWindow.document.write('<html><head><title>حالة النظام</title></head><body>');
        statusWindow.document.write('<h2>معلومات النظام</h2>');
        statusWindow.document.write('<pre style="background:#f8f9fa;padding:15px;border-radius:5px;font-family:monospace;">' + data + '</pre>');
        statusWindow.document.write('</body></html>');
    });
}

function changePassword() {
    const newPassword = prompt('أدخل كلمة المرور الجديدة (6-20 حرف):');
    if (newPassword && newPassword.length >= 6 && newPassword.length <= 20) {
        fetch('/admin/change-password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({password: newPassword})
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        });
    } else if (newPassword) {
        alert('كلمة المرور يجب أن تكون بين 6-20 حرف');
    }
}

function changeResolution() {
    const resolutions = ['1024x768', '1280x720', '1280x1024', '1920x1080'];
    const current = '{{ session.screen_resolution if session else "1024x768" }}';
    let choice = '';
    
    for (let i = 0; i < resolutions.length; i++) {
        choice += `${i + 1}. ${resolutions[i]}${resolutions[i] === current ? ' (حالي)' : ''}\n`;
    }
    
    const selection = prompt(`اختر الدقة الجديدة:\n${choice}\nأدخل الرقم (1-4):`);
    const index = parseInt(selection) - 1;
    
    if (index >= 0 && index < resolutions.length) {
        fetch('/admin/change-resolution', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({resolution: resolutions[index]})
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) window.location.reload();
        });
    }
}

// Auto-refresh every 30 seconds
setInterval(() => {
    window.location.reload();
}, 30000);
</script>
{% endblock %}